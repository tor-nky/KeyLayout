# Windows で薙刀式v13完成版 を使うスクリプト

[薙刀式v13完成版](http://oookaworks.seesaa.net/article/479173898.html#gsc.tab=0) 2020年12月25日版を Autohotkey に実装しました。

### Naginata.ahk

ディレクトリ source の下にあるファイルをすべて保存します。

Autohotkey をインストールし、ディレクトリ source にある Naginata.ahk のスクリプトを実行してください。

Naginata.ahk 内にある固有名詞ショートカットを書き換えて実行することができます。
Naginata.ahk を名前を変えてコピーすれば、複数の固有名詞ショートカットを使い分けられます。

この場合、複数個が同時起動しないようにしてください。

Ahk2Exe.exe でコンパイルする場合は、Unicode版で出力してください。

### Naginata.exe

すぐに試してみたい方のために、コンパイルした物を用意しました。ウイルス対策ソフトが反応してしまう場合がありますので、その際はご自分でコンパイルしてください。

新旧MS-IMEに対応させましたが、そのせいで編集モードの一部の記号入力がゆっくりになり、また Shift+[ 、Shift+] で『』を入力したあとは文字確定になります。

# IME の設定

### 旧MS-IME

初期状態の設定のままでも使えますが、キー設定を行うことをおすすめします。

半角+全角	→	[入力/変換文字なし]IMEオフ, [他]半英固定

### 新MS-IME

初期状態の設定で使います。

### ATOK

ソースコードにあるコメントをご覧ください。

## 動作確認

* Windows 10 Home version 20H2 + AutoHotkey (v1.1.33.02) + 新旧MS-IME あるいは ATOK 2017

# 不具合

* 新MS-IME で、薙刀式に変換しなかったり、かな入力が行えなくなることがある。

新MS-IME 自体の不具合です。

* 新MS-IME で、かな変換中に英数入力に切り替え、確定しないでキーを押すと最初の文字が入力されない。

新MS-IME の仕様です。

* ATOK で使うと動作が緩慢に見える

# 参考

* [【薙刀式】v13完成版、発表。](http://oookaworks.seesaa.net/article/479173898.html#gsc.tab=0)

## KanaTable.ahk で使えるキーや記号の書き方

Autohotkey の書き方に準じます。

(http://ahkwiki.net/Send) の特殊キー名一覧もご覧ください。

そのまま入力	0〜9 A〜Z -^@[]./ 全角文字

{Enter} {Esc} {Space} {Tab} {BS} {Del} {Ins}
{Up} {Down} {Left} {Right}
{Home} {End} {PgUp} {PgDn}
など

## 動作速度

* 最初の読み込み

２秒程度

* 英数、かなの普通の文字

通常 5 ms 以内、エクスプローラー 78 ms 以内。

* 記号

長いもので 260 ms

## おもな修正履歴

* (Naginata.ahk) 例えば「う」押す→「スペース」押す→「う」離す、でスペースが発行されていたのを修正（大岡様ありがとうございました）
* (Naginata.ahk) 3キー以上を限りなく同時に押すと、2文字までしか入力されないことがある、のを修正

(ここまで2021年2月9日追加)

* (KanaTable.ahk) エクスプローラーの検索欄で入力が失敗する、３文字のローマ字のディレイを設定し直した

(ここまで2021年2月10日追加)

* (Naginata.ahk) リセット機能を強化
* (init.ahk) {確定}機能の最初の実装
* (KanaTable.ahk) 記号入力で改行されすぎる不具合の解消

(ここまで2021年2月11日追加)

* (Naginata.ahk) リセット機能の不完全な実装を解消
* (KanaTable.ahk) 何も出力しない「Q」単打の「出力」を、Windows が無反応だった頃の「かな」キーのスキャンコードに変更

(ここまで2021年2月12日追加)

* (Naginata.ahk) 入力部分の強化
* (init.ahk) 定義をされているかなを元に戻せるようにした
* (KanaTable.ahk) 一部かな定義の間違いを訂正。ディレイの修正

(ここまで2021年2月13日追加)

* 出力速度の最適化
* ディレイの設定を不要にした。ある場合はこれまでと同様の動作、ない場合は自動設定される。

(ここまで2021年2月18日追加)

* 同じキーを連打して取りこぼすことが、主に編集モードで起きていたのを解消した
* Shift + 半角/全角 の動作を直した

(ここまで2021年2月19日追加)

* 編集モードでロールオーバーができない組み合わせを解消した
* (init.ahk) {確定}機能を再実装。Ctrl+Enter を入力します。
* (init.ahk) {固定}機能を実装。「n」→改行→BS を入力します。新MS-IMEでユニコード入力の前に使います。
* (KanaTable.ahk) 記号入力で改行されすぎる不具合の再度の解消
* (Naginata.ahk) 入力バッファの大きさを調節(キーを押す時は6個残す)

すべてのファイルを入れ替えた場合のみ、修正が有効になります。

(ここまで2021年2月21日追加)

* (Naginata.ahk) スペースキーを押しながらのカーソルキー、Home、End、PageUp、PageDown をシフトキーを押しながらと同じ動作になるようにした
* (init.ahk) ユニコード文字の前後でかな入力を確定する操作を入れた。「nn」→Control+Enter→BS
* (init.ahk)(KanaTable.ahk) そのため、{確定} {固定} 機能を廃止

(ここまで2021年2月23日追加)

* (init.ahk) × はユニコード文字でないことがわかったので、調整
* (Naginata.ahk) ATOK に対応させるために出力タイミングを調整

(ここまで2021年2月24日追加)

* (KanaTable.ahk) Shift+ろ → ＿

(ここまで2021年2月26日追加)

* (Naginata.ahk) キーを離してもシフトが残ることがあるのを修正

(ここまで2021年2月27日追加)

* (KanaTable.ahk) 内容は薙刀式創作者である大岡様の著作物のため、著作権表記を変更した。

(ここまで2021年3月1日追加)

* ファイル構成の変更
* 時限式の後置シフトを実装(初期設定は通常シフト)

Naginata.ahk 24行目に設定があります。
たとえば後置シフトを60ミリ秒まで認める場合、
ShiftDelay := 60
とします。

* 冗長シフトの削除

Naginata.ahk 17行目を
#Include KanaTable/OldNaginataTable.ahk
と書き換えれば、以前のものと同じになります。
このとき後置シフトにすると、どれかキーを上げるまで字が入らないことがあります。

(ここまで2021年3月14日追加)

* (Conv.ahk) 後置シフトが有効の時だけ、高精度タイマーを使うようにした

(ここまで2021年4月8日追加)
