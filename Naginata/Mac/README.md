# Mac を 薙刀式 v13完成版（仮） にするスクプリト

* 薙刀式.json

Windows版、QMK版の薙刀式は、押したキーをどれか離すと計算がおこなわれ、画面に出力されます。

ですが、Mac の Karabier-Elements ではキーを押したときに、離したときの動作が決まってしまい、後で変えられません。

そこで、キーを何でも押した瞬間に出力し、もう１、２個キーを同時押ししたら、その都度戻って出し直す方法を使うようにしました。

## 使用方法

JISキーボードにもUSキーボードにも対応しています。

Karabiner-Elements で英語系の配列より上に登録してください。
他の英語系の配列が無効になりますが、Excelワークシートの書き換えで実装できます。

新配列は、パスワード入力時は無効、Command、Optionキーと併用時は有効です。

### 【重要】かわせみ2 でのみ動作します。

入力方法にローマ字入力を使います。
かわせみ2 をインストールそのままの状態では、一部の入力がうまくいきません。下の方の Q & A の Q5. をご覧ください。

キー割り当ての「日本語IMタイプ」ならそのまま使えます。
ローマ字タイプの「標準タイプ」「日本語IMタイプ」「MS-IMEタイプ」は使えました。


macOS Mojave (10.14.6) + Karabiner-Elements (v12.10.0) + かわせみ2 (2.0.17) でテスト継続中です。

## シフト方式

スペースキー、シフトキーのどちらもシフトとして操作できます。

## 固定名詞ショートカット

一緒に公開した Excel のワークシートで、「固定名詞」タブ内に書き込んで、次の方法でスクリプトを作成し直して、入れ換えの登録をおこなってください。

1. Excel の左上の「A4」とか書いてある部分の矢印をクリックする
2. 「スクリプト」を選ぶ
3. Command + C でコピーする
4. テキストエディットで新規書類を作り、「フォーマット」から「標準テキストにする」としてからペーストする。
5. 「Naginata.json」などのファイル名でフォルダ ~/.config/karabiner/assets/complex_modifications/ に保存する
6. Karabiner-Elements で古い登録を削除して、今度作ったものを再登録する

ただし、ワークシートは Office 365 の新機能を使っていますが、ネット上で動作する Office でお使いいただけます。
Mac版Excel にある「あ」と「ぁ」のような小書き文字との区別がつかない問題も起きないので、おすすめします。

１個所あたり２０文字までとしましたが、２０文字の入力に２〜６秒かかります。

## 問題点

右手だけのロールオーバー入力はほとんどできます。

ページ移動でページの先頭に行かない。カーソルも移動しない。

## Q & A

### Q1. １つ目のキーを押した瞬間に出力がおきるので、選択範囲を削除することが起こる。

A1. 右側の編集モードは、なるべく D+F、または C+V の２キーの組み合わせを同時押ししてから、右側のキーを押してください。

### Q2. かな変換中に V+M を押すと、確定+改行とになる

A2. V+M を同時押ししてください。

その代わり、次の操作の前にどちらのキーも離しましょう。

### Q3. スペース、左、右、BS の反応が悪い。

A3. これらのキーは、離したときに実行される仕様のためです。

### Q4. スペース、左、右、BS を長押ししてから離すとなにも起きない。

A4. Karabiner-Elements 設定の「Complex Modifications」項目内「Parameters」タブの
「to_if_alone_timeout_milliseconds」の値を長くしてみてください。
初期設定は1000ミリ秒（１秒）です。

D+F の同時押し、C+V の同時押しをして編集モード右側のキーを押さずに離した場合も、長押し時間によっては、同じことが起こります。

### Q5. スペース(シフト)を押しながら「が」といった２キー同時押しをすると、「あが」などと入力される

A5. かわせみ2 のキー割り当て編集ツールで、「読み操作」内の「文節前削除」に [shift]+[delete] を加え、保存します。

かわせみ2 の環境設定、「操作」内の「キー割り当て」に、保存したものを登録してください。

[shift]+[delete] を、カーソル位置削除として今後も使うなら、https://ke-complex-modifications.pqrs.org(公式)の Change delete key で利用できます。

## 変数

* USC: 未確定文字の数（０〜２）

例：あ＋る→ある＋し→じょ　「ある」を入力したところで２、「し」を入力されたら２文字削除して「じょ」を入力する。

確定する複数キー押し、キーを離したときは０になります。

* LKS: 直前の同時押しキーの数 （１〜２）

ロールオーバーで２キー同時押しが続くときに、１文字目が消えて新しい文字を入力されるのを避けるために用意。

３キー同時押し（シフトを数えず）は全て確定になるので、３の代入を省略しています。

例：語尾、ボビン、ポピー

## おもな修正履歴

* Excel ワークシートの全面改定
* 編集モードの定義を見直し
* 順序の入れ替え
* 変数利用の条件替えなど

(ここまで2020年11月1日 大幅改定)

* ワークシートがネット上の Office で使用できることを確認
* Q & A に5番を追加

(ここまで 2020年11月3日追加)
